# Скрипт создания среды Creatio на базе .NET Core (linux) + Postgres #

Скрипт предназначен для автоматического создания и запуска образов и контейнеров, необходимых для функционирования

## Требования для работы скрипта ##

На целевом хосте должны быть выполнены следующие требования:
1. Целевой хост - Windows.
2. Установлен Docker.
3. Настроена [политика](https://learn.microsoft.com/ru-ru/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.3) запуска внешних PowerShell скриптов без подписи.

### Общий вид алгоритма: ###


1. Генерация docker-compose файлов для работы в этом экземпляре скрипта на основе docker-compose-template
2. Переименование файла бекапа, расположенного в *MyApplication*/db
3. Проверка наличия запущенных контейнеров, совпадающих с текущими по скрипту. В случае их обнаружения, скрипт завершает работу с ошибкой. Необходимо остановить и удалить данные контейнеры для дальнейшей работы скрипта.
4. Создание docker-сети для работы контейнеров друг с другом.
5. Создание контейнеров с бэкендом: PostgreSQL, PGAdmin, Redis.
6. Создание **роли** в PostgreSQL, создание **базы данных приложения**, её **восстановление из бекапа**. 
В случе уже имеющейся роли или базы данных, скрипт завершает работу с ошибкой. Это сделано для предотвращения случайного удаления данных при восстановлении базы данных. 
7. Обновление конфигурационных файлов Приложения.
8. Обновление EXPOSE портов в DockerFile
9. Обновление портов для запуска приложения в appsSettings.json
10. Создание контейнера с Приложением.

## Docker-compose ##
Скрипт опирается на два Docker-Compose файла. Из них будут сгенерированы docker-compose файлы для данного проекта:

* **docker-compose.creatio-db-template.yml** - отввечает за развёртывание контейнеров для бекенда (psql, redis, pgadmin)
* **docker-compose.creatio-linux-template.yml** - отвечает за развёртывание контенейнера приложения

Сервисы разделены на два Docker-Compose файла для удобства дальнейшего обслуживания окружения. 


## Инструкция по запуску ##
1. Настроить политику запуска скриптов:
 ![Get-ExecutionPolicy -list](<Screenshot 2023-10-09 180916-1.png>)
2. Разархивировать исходное приложение. Далее - папка разархивированного приложения будет являться **корнем (/)**.
3. Переместить файлы **build.ps1**, **docker-compose.creatio-db-template.yml**, **docker-compose.creatio-linux-template.yml** в корень.
4. Сконфигурировать файл **build.ps1**: 
    * Настроить название проекта
    * Настроить название окружения
    * Указать номер базы данных redis (для создания нескольких инстансов)
    * При необходимости настроить ip docker-сети приложения
5. Если планируется использование данного скрипта для разворачивания на **https**, то необходимо **убрать** один элемент основого процесса скрипта: 
    ```PowerShell
    UpdateFile -Path "Terrasoft.WebHost.dll.config" -SearchPattern '<add key="CookiesSameSiteMode" value="None" />' -ReplacePattern '<add key="CookiesSameSiteMode" value="Lax" />'
    ```

## Запуск приложения, доступ к pgadmin4 ##
В результате работы скрипта будет созданы контейнеры
Для запуска приложения щелкнуть по порту контейнера с приложением 5000:5000

Для подключения к pgadmin необходимо перейти из docker к адресу pgadmin на порту 80
Стандартный логин и пароль описаны в docker-compose.creatio-db-template.yml 

* PGADMIN_DEFAULT_EMAIL: pgadmin4@pgadmin.org
* PGADMIN_DEFAULT_PASSWORD: admin

Для подключения к базе из pgadmin необходмо узнать IP для подключения к БД.
Это можно сделать, провалившись в контейнер базы данных и на вкладке Inspect 
![DBcontainer->Inspect->Networks](<Screenshot 2023-10-09 193534-1.png>)

В pgadmin зарегистирорвать сервер (если не были указаны иные настройки для администратора БД):
* hostname/Ip = Ip базы из контейнера БД
* port = 5432
* Username = postgres
* Password = postgres 

![ConnectionToPSQL](<Screenshot 2023-10-09 194251-1.png>)


## Протестировано ##
- Docker Desktop 4.24.1 (123237)
- Windows 11 22H2 (22621.2361)
- 7_18_5_1501_SalesEnterprise_Linux_Softkey_PostgreSQL_ENU_NetCore

## Известные проблемы ##

- Проблема с переводом на русский язык - не все элементы интерфейса были переведены 
- Ошибка при Восстановлении базы данных
    1. Пользователь отличен от пользователя с ролью owner из файла бекапа
        - **Решение:** изменить параметр <span style="color:lightblue"> $PostgreSqlUser </span> на необходимого пользователя
    2. Восстановление БД невозможно, ошибка подключения, база не найдена, не существует пользователя
        - **Решение:** Проверить соответствие параметра <span style="color:lightblue"> $PostgreSqlDbBackup </span> и названия файла в /db/... 
        - **Решение:** в названиях использовать нижний регистр латиницы и нижнее подчеркивание "_". (Дело в том, что докер игнорирует верхний регистр при создании базы, а при восстановлении не может найти корректный путь/файл)
- Не удается войти в приложение
    - **Решение:** проверить тип соеднинения (http или https)
    и изменить параметр на Lax - для http и none для https
    ```shell
    <add key="CookiesSameSiteMode" value="Lax" />
    ```
- Ошибка существования docker-сети
    Возможно, под другим названием существует сеть с выделенным ip
    1. Изменить параметр **$NetworkIP** 